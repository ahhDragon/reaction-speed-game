# 实现计划：反应速度测试游戏

## 概述

本实现计划将反应速度测试游戏分解为增量式的开发任务。游戏使用 TypeScript 开发，采用事件驱动架构，通过精确的时间测量和即时反馈机制测试用户的视觉反应速度。实现将从核心接口和数据模型开始，逐步构建游戏逻辑、UI 渲染和增强反馈系统。

## 任务

- [x] 1. 设置项目结构和核心接口
  - 创建项目目录结构（src/、tests/）
  - 配置 TypeScript 编译选项（tsconfig.json）
  - 定义核心接口：GameController、TimerService、StateManager、UIRenderer
  - 定义数据模型：GameRound、PerformanceRating、GameConfig
  - 定义 GameState 枚举
  - 设置测试框架（Jest/Vitest 和 fast-check）
  - _需求: 所有需求的基础_

- [x] 2. 实现 TimerService
  - [x] 2.1 实现高精度时间戳获取
    - 实现 getCurrentTimestamp() 方法，使用 performance.now() 或 Date.now()
    - 确保返回毫秒级精度的时间戳
    - _需求: 2.4, 3.1, 4.1_
  
  - [x] 2.2 编写 TimerService 的属性测试
    - **属性 4: 颜色变化时间戳被记录**
    - **属性 5: 点击时间戳被记录**
    - **验证: 需求 2.4, 3.1**
  
  - [x] 2.3 实现延迟执行功能
    - 实现 setDelay() 方法，封装 setTimeout
    - 实现 cancelDelay() 方法，清除定时器
    - 保存定时器引用以便取消
    - _需求: 2.1, 7.3, 8.3_
  
  - [x] 2.4 编写 TimerService 的单元测试
    - 测试时间戳的有效性（非空、正数）
    - 测试延迟执行的准确性
    - 测试取消延迟的功能
    - _需求: 2.4, 3.1_

- [x] 3. 实现 StateManager
  - [x] 3.1 实现状态管理核心逻辑
    - 实现 getCurrentState() 和 setState() 方法
    - 实现状态变化的观察者模式（onStateChange）
    - 添加状态转换验证，防止非法转换
    - _需求: 所有需求的状态管理基础_
  
  - [x] 3.2 编写 StateManager 的单元测试
    - 测试合法的状态转换
    - 测试非法状态转换的处理
    - 测试状态变化通知机制
    - _需求: 所有需求的状态管理基础_

- [x] 4. 实现 GameConfig 和配置管理
  - [x] 4.1 创建游戏配置对象
    - 定义色块尺寸（至少 200x200 像素）
    - 定义初始颜色和变化后颜色（视觉上有明显区别）
    - 定义等待时间范围（1000-5000ms）
    - 定义轮次间隔（1000ms）
    - 定义提前点击提示显示时间（1000ms）
    - 定义性能评价阈值（200ms, 300ms, 400ms）
    - _需求: 1.2, 2.1, 2.3, 6.1-6.4, 7.3, 8.3_
  
  - [x] 4.2 编写配置验证的属性测试
    - **属性 1: 色块尺寸满足最小要求**
    - **验证: 需求 1.2**

- [ ] 5. 实现 UIRenderer
  - [x] 5.1 实现色块渲染功能
    - 创建 HTML 结构（色块容器、结果显示区、消息提示区）
    - 实现 renderColorBlock() 方法，设置色块颜色和尺寸
    - 确保色块在网页中心显示，具有明显边界
    - _需求: 1.1, 1.2, 1.3_
  
  - [x] 5.2 实现结果显示功能
    - 实现 displayResult() 方法，显示反应时间和性能评价
    - 格式化显示：包含数值、单位（毫秒）和评价文字
    - 确保结果显示清晰可见
    - _需求: 4.2, 4.3, 5.1, 5.2, 5.3, 6.5_
  
  - [x] 5.3 实现增强反馈系统
    - 根据性能评价显示不同的文字描述（鼓励性语言）
    - 实现界面特效：
      - 优秀：绿色闪光动画 + "太快了！" 文字
      - 良好：蓝色脉冲动画 + "不错！" 文字
      - 一般：黄色淡入淡出 + "继续加油！" 文字
      - 需要提高：橙色提示 + "再试一次！" 文字
    - 使用 CSS 动画或 JavaScript 动画实现特效
    - _需求: 6.1-6.5（用户增强需求）_
  
  - [x] 5.4 实现消息提示功能
    - 实现 displayMessage() 方法，显示提示信息
    - 实现 displayInstructions() 方法，显示游戏说明
    - _需求: 7.1, 9.2_
  
  - [~] 5.5 编写 UIRenderer 的属性测试
    - **属性 9: 反应时间显示包含单位**
    - **属性 12: 结果同时显示反应时间和评价**
    - **验证: 需求 4.2, 5.1, 5.2, 6.5_
  
  - [~] 5.6 编写 UIRenderer 的单元测试
    - 测试色块渲染的尺寸和位置
    - 测试结果显示的格式
    - 测试增强反馈的文字和特效
    - 测试消息提示的显示
    - _需求: 1.1-1.3, 4.2, 5.1-5.3, 6.5, 7.1, 9.2_

- [ ] 6. 检查点 - 确保基础组件测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 7. 实现性能评价逻辑
  - [x] 7.1 实现评价计算函数
    - 根据反应时间返回对应的性能评价
    - 实现评价阈值判断逻辑
    - _需求: 6.1, 6.2, 6.3, 6.4_
  
  - [~] 7.2 编写性能评价的属性测试
    - **属性 11: 性能评价正确性**
    - **验证: 需求 6.1-6.4**
  
  - [~] 7.3 编写性能评价的单元测试
    - 测试边界值（200ms, 300ms, 400ms）
    - 测试典型值（150ms, 250ms, 350ms, 500ms）
    - _需求: 6.1-6.4_

- [ ] 8. 实现 GameController 核心逻辑
  - [x] 8.1 实现游戏初始化
    - 实现 initialize() 方法
    - 初始化 StateManager、TimerService、UIRenderer
    - 显示初始状态的色块和游戏说明
    - 设置点击事件监听器
    - _需求: 9.1, 9.2_
  
  - [x] 8.2 实现游戏轮次启动逻辑
    - 实现 startRound() 方法
    - 生成随机等待时间（1000-5000ms）
    - 重置色块到初始颜色
    - 设置状态为 WAITING
    - 在等待期结束后改变色块颜色并记录时间戳
    - 设置状态为 READY
    - _需求: 2.1, 2.2, 2.4, 8.2_
  
  - [~] 8.3 编写游戏轮次启动的属性测试
    - **属性 2: 等待时间在有效范围内**
    - **属性 3: 等待期结束后颜色改变**
    - **属性 16: 新轮次色块颜色重置**
    - **验证: 需求 2.1, 2.2, 8.2**
  
  - [x] 8.4 实现点击处理逻辑
    - 实现 handleClick() 方法
    - 验证点击是否在色块区域内
    - 根据当前状态处理点击：
      - INITIAL: 开始第一轮游戏
      - WAITING: 识别为提前点击，显示提示，重新开始
      - READY: 记录点击时间戳，计算反应时间，显示结果
      - 其他状态: 忽略点击
    - _需求: 3.1, 3.2, 3.3, 3.4, 7.1, 7.2, 9.3_
  
  - [~] 8.5 编写点击处理的属性测试
    - **属性 6: 提前点击被正确识别和处理**
    - **属性 7: 点击区域验证**
    - **属性 8: 反应时间计算正确性**
    - **验证: 需求 3.1-3.4, 7.1, 7.2**
  
  - [x] 8.6 实现反应时间计算和结果显示
    - 计算反应时间（点击时间戳 - 颜色变化时间戳）
    - 调用性能评价函数获取评价
    - 调用 UIRenderer 显示结果（包含增强反馈）
    - 设置状态为 RESULT
    - _需求: 4.1, 4.2, 4.3, 5.1, 5.2, 5.3, 6.5_
  
  - [~] 8.7 编写反应时间计算的单元测试
    - 测试反应时间计算的准确性
    - 测试结果显示的完整性
    - _需求: 4.1, 4.2, 4.3_

- [ ] 9. 实现游戏循环和状态转换
  - [-] 9.1 实现提前点击处理流程
    - 显示"提前点击"提示信息
    - 延迟至少 1000ms
    - 重新开始当前游戏轮次
    - _需求: 7.1, 7.2, 7.3_
  
  - [~] 9.2 编写提前点击处理的属性测试
    - **属性 13: 提前点击后游戏重置**
    - **属性 14: 提前点击提示显示时长**
    - **验证: 需求 7.2, 7.3**
  
  - [~] 9.3 实现游戏轮次自动循环
    - 在结果显示后延迟至少 1000ms
    - 自动开始新的游戏轮次
    - _需求: 8.1, 8.3_
  
  - [~] 9.4 编写游戏循环的属性测试
    - **属性 10: 反应时间显示持久性**
    - **属性 15: 游戏轮次自动循环**
    - **属性 17: 轮次间隔时间**
    - **验证: 需求 5.3, 8.1, 8.3**
  
  - [~] 9.5 实现重置功能
    - 实现 reset() 方法
    - 清除所有定时器
    - 重置状态到 INITIAL
    - 清空游戏数据
    - _需求: 所有需求的错误恢复基础_

- [ ] 10. 实现错误处理
  - [~] 10.1 添加时间戳验证
    - 验证时间戳的有效性（非空、正数、递增）
    - 处理时间戳异常，重新开始游戏轮次
    - _需求: 2.4, 3.1, 4.1_
  
  - [~] 10.2 添加点击事件验证
    - 验证事件对象的完整性
    - 处理无效点击事件
    - _需求: 3.1, 3.4_
  
  - [~] 10.3 添加 DOM 元素验证
    - 在初始化时验证所有必需的 DOM 元素
    - 处理元素缺失的情况
    - _需求: 1.1, 9.1_
  
  - [~] 10.4 编写错误处理的单元测试
    - 测试各种异常情况的处理
    - 测试错误恢复机制
    - _需求: 所有需求的错误处理_

- [ ] 11. 检查点 - 确保核心功能测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 12. 创建 HTML 页面和样式
  - [~] 12.1 创建 HTML 结构
    - 创建 index.html 文件
    - 添加色块容器、结果显示区、消息提示区
    - 引入 TypeScript 编译后的 JavaScript 文件
    - _需求: 1.1, 9.1_
  
  - [~] 12.2 创建 CSS 样式
    - 设置色块样式（尺寸、边界、居中）
    - 设置结果显示样式
    - 设置消息提示样式
    - 实现增强反馈的动画效果（闪光、脉冲、淡入淡出）
    - 确保响应式设计
    - _需求: 1.2, 1.3, 5.1, 5.2, 6.5（用户增强需求）_

- [ ] 13. 集成和连接所有组件
  - [~] 13.1 创建主入口文件
    - 创建 main.ts 文件
    - 实例化所有组件
    - 调用 GameController.initialize()
    - 设置全局错误处理
    - _需求: 所有需求的集成_
  
  - [~] 13.2 配置构建工具
    - 配置 TypeScript 编译
    - 配置打包工具（如 Webpack、Vite 或 Parcel）
    - 确保开发服务器可以运行
    - _需求: 所有需求的构建基础_
  
  - [~] 13.3 编写端到端集成测试
    - 测试完整的游戏流程（初始化 → 首次点击 → 等待 → 颜色变化 → 点击 → 显示结果 → 新轮次）
    - 测试提前点击流程
    - 测试多轮游戏循环
    - 测试增强反馈的显示
    - _需求: 所有需求的集成测试_

- [ ] 14. 最终检查点 - 确保所有测试通过
  - 运行所有单元测试、属性测试和集成测试
  - 确保代码覆盖率达到至少 90%
  - 确保所有 17 个正确性属性都有对应的属性测试
  - 在浏览器中手动测试游戏功能
  - 如有问题请询问用户。

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用的正确性属性
- 单元测试验证具体的示例和边界情况
- 增强反馈系统（任务 5.3）满足用户提出的额外需求
